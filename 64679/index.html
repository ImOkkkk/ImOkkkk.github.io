<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 3.9.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">
  <meta name="baidu-site-verification" content="bUCDF5pEQe">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">
<script type="text/javascript" src="http://tajs.qq.com/stats?sId=66522575" charset="UTF-8"></script>
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"tonymua.top","root":"/","scheme":"Pisces","version":"7.8.0","exturl":true,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":"default"},"back2top":{"enable":true,"sidebar":true,"scrollpercent":true},"bookmark":{"enable":true,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":true,"pangu":true,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":true,"preload":true},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="1.课程搜索需求分析1.1 需求分析 根据分类搜索课程信息。 根据关键字搜索课程信息，搜索方式为全文检索，关键字需要匹配课程的名称、 课程内容。  根据难度等级搜索课程。  搜索结点分页显示。">
<meta name="keywords" content="项目">
<meta property="og:type" content="article">
<meta property="og:title" content="学成在线(十三.课程搜索)">
<meta property="og:url" content="http://tonymua.top/64679/index.html">
<meta property="og:site_name" content="liuwy1998 BLOG">
<meta property="og:description" content="1.课程搜索需求分析1.1 需求分析 根据分类搜索课程信息。 根据关键字搜索课程信息，搜索方式为全文检索，关键字需要匹配课程的名称、 课程内容。  根据难度等级搜索课程。  搜索结点分页显示。">
<meta property="og:locale" content="zh-CN">
<meta property="og:updated_time" content="2020-04-29T02:44:38.112Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="学成在线(十三.课程搜索)">
<meta name="twitter:description" content="1.课程搜索需求分析1.1 需求分析 根据分类搜索课程信息。 根据关键字搜索课程信息，搜索方式为全文检索，关键字需要匹配课程的名称、 课程内容。  根据难度等级搜索课程。  搜索结点分页显示。">

<link rel="canonical" href="http://tonymua.top/64679/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>学成在线(十三.课程搜索) | liuwy1998 BLOG</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="liuwy1998 BLOG" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">liuwy1998 BLOG</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">When they go low,we go high.</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档<span class="badge">87</span></a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签<span class="badge">35</span></a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类<span class="badge">10</span></a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="reading-progress-bar"></div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://tonymua.top/64679/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/../assets/img/head.jpg">
      <meta itemprop="name" content="liuwy1998">
      <meta itemprop="description" content="Java开发, 后端开发">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="liuwy1998 BLOG">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          学成在线(十三.课程搜索)
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-05-08 21:19:59" itemprop="dateCreated datePublished" datetime="2021-05-08T21:19:59+08:00">2021-05-08</time>
            </span>

          
            <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span id="busuanzi_value_page_pv"></span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h3 id="1-课程搜索需求分析"><a href="#1-课程搜索需求分析" class="headerlink" title="1.课程搜索需求分析"></a>1.课程搜索需求分析</h3><h4 id="1-1-需求分析"><a href="#1-1-需求分析" class="headerlink" title="1.1 需求分析"></a>1.1 需求分析</h4><ol>
<li>根据分类搜索课程信息。</li>
<li>根据关键字搜索课程信息，搜索方式为全文检索，关键字需要匹配课程的名称、 课程内容。 </li>
<li>根据难度等级搜索课程。 </li>
<li>搜索结点分页显示。 </li>
</ol>
<a id="more"></a>

<p><img data-src="../../../../assets/img/160829.jpg" alt></p>
<h4 id="1-2-搜索流程"><a href="#1-2-搜索流程" class="headerlink" title="1.2 搜索流程"></a>1.2 搜索流程</h4><p><img data-src="../../../../assets/img/160934.jpg" alt></p>
<ol>
<li>课程管理服务将数据写到MySQL数据库 </li>
<li>使用Logstash将MySQL数据库中的数据写到ES的索引库。</li>
<li>用户在前端搜索课程信息，请求到搜索服务。 </li>
<li>搜索服务请求ES搜索课程信息。 <h3 id="2-全文检索技术研究"><a href="#2-全文检索技术研究" class="headerlink" title="2.全文检索技术研究"></a>2.全文检索技术研究</h3>研究ElasticSearch搜索方法。<blockquote>
<p>参考：学成在线(十二.ElasticSearch(一))    学成在线(十二.ElasticSearch(二))</p>
</blockquote>
<h3 id="3-课程索引"><a href="#3-课程索引" class="headerlink" title="3.课程索引"></a>3.课程索引</h3><h4 id="3-1-技术方案"><a href="#3-1-技术方案" class="headerlink" title="3.1 技术方案"></a>3.1 技术方案</h4>如何维护课程索引信息？</li>
<li>当课程向MySQL添加后同时将课程信息添加到索引库。 采用Logstach实现，Logstach会从MySQL中将数据采集到ES索引库。</li>
<li>当课程在MySQL更新信息后同时更新该课程在索引库的信息。 采用Logstach实现。</li>
<li>当课程在MySQL删除后同时将该课程从索引库删除。<br>手工写程序实现，在删除课程后将索引库中该课程信息删除。<h4 id="3-2-准备课程索引信息"><a href="#3-2-准备课程索引信息" class="headerlink" title="3.2 准备课程索引信息"></a>3.2 准备课程索引信息</h4>课程发布成功在MySQL数据库存储课程发布信息，此信息作为课程索引信息。<h5 id="3-2-1-创建课程发布表"><a href="#3-2-1-创建课程发布表" class="headerlink" title="3.2.1 创建课程发布表"></a>3.2.1 创建课程发布表</h5>课程信息分布在course_base、course_pic等不同的表中。<br>课程发布成功后, 为了方便进行索引将这几张表的数据合并在一张表中，作为课程发布信息。<br><img data-src="../../../../assets/img/203812.jpg" alt></li>
</ol>
<h5 id="3-2-2-创建课程发布表模型"><a href="#3-2-2-创建课程发布表模型" class="headerlink" title="3.2.2 创建课程发布表模型"></a>3.2.2 创建课程发布表模型</h5><p>在课程管理服务创建模型：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@ToString</span></span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Table</span>(name=<span class="string">"course_pub"</span>)</span><br><span class="line"><span class="meta">@GenericGenerator</span>(name = <span class="string">"jpa-assigned"</span>, strategy = <span class="string">"assigned"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CoursePub</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = -<span class="number">916357110051689487L</span>;</span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="meta">@GeneratedValue</span>(generator = <span class="string">"jpa-assigned"</span>)</span><br><span class="line">    <span class="meta">@Column</span>(length = <span class="number">32</span>)</span><br><span class="line">    <span class="keyword">private</span> String id;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> String users;</span><br><span class="line">    <span class="keyword">private</span> String mt;</span><br><span class="line">    <span class="keyword">private</span> String st;</span><br><span class="line">    <span class="keyword">private</span> String grade;</span><br><span class="line">    <span class="keyword">private</span> String studymodel;</span><br><span class="line">    <span class="keyword">private</span> String teachmode;</span><br><span class="line">    <span class="keyword">private</span> String description;</span><br><span class="line">    <span class="keyword">private</span> String pic;<span class="comment">//图片</span></span><br><span class="line">    <span class="keyword">private</span> Date timestamp;<span class="comment">//时间戳</span></span><br><span class="line">    <span class="keyword">private</span> String charge;</span><br><span class="line">    <span class="keyword">private</span> String valid;</span><br><span class="line">    <span class="keyword">private</span> String qq;</span><br><span class="line">    <span class="keyword">private</span> Double price;</span><br><span class="line">    <span class="keyword">private</span> Double price_old;</span><br><span class="line">    <span class="keyword">private</span> String expires;</span><br><span class="line">    <span class="keyword">private</span> String teachplan;<span class="comment">//课程计划</span></span><br><span class="line">    <span class="meta">@Column</span>(name=<span class="string">"pub_time"</span>)</span><br><span class="line">    <span class="keyword">private</span> String pubTime;<span class="comment">//课程发布时间</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="3-2-3-修改课程发布"><a href="#3-2-3-修改课程发布" class="headerlink" title="3.2.3 修改课程发布"></a>3.2.3 修改课程发布</h5><p>在课程管理服务定义dao：</p>
<ol>
<li><p>创建course_pub表的dao</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">CoursePubRepository</span> <span class="keyword">extends</span> <span class="title">JpaRepository</span>&lt;<span class="title">CoursePub</span>,<span class="title">String</span>&gt; </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>在CourseService中修改课程发布方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">@Transactional</span></span><br><span class="line"> <span class="function"><span class="keyword">public</span> CoursePublishResult <span class="title">publish</span><span class="params">(String id)</span> </span>&#123;</span><br><span class="line">------</span><br><span class="line">     <span class="comment">//保存课程索引信息</span></span><br><span class="line">     <span class="comment">//创建一个coursePub对象</span></span><br><span class="line">     CoursePub coursePub = createCoursePub(id);</span><br><span class="line">     <span class="comment">//将coursePub对象保存到数据库</span></span><br><span class="line">     saveCoursePub(id, coursePub);</span><br><span class="line">    ------</span><br><span class="line"> &#125;</span><br><span class="line">     <span class="comment">//创建coursePub对象</span></span><br><span class="line"> <span class="function"><span class="keyword">private</span> CoursePub <span class="title">createCoursePub</span><span class="params">(String id)</span></span>&#123;</span><br><span class="line">     CoursePub coursePub=<span class="keyword">new</span> CoursePub();</span><br><span class="line">     <span class="comment">//根据课程id查询course_base</span></span><br><span class="line">     Optional&lt;CourseBase&gt; baseOptional = courseBaseRepository.findById(id);</span><br><span class="line">     <span class="keyword">if</span> (baseOptional.isPresent())&#123;</span><br><span class="line">         CourseBase courseBase = baseOptional.get();</span><br><span class="line">         <span class="comment">//将courseBase属性拷贝到CoursePub中</span></span><br><span class="line">         BeanUtils.copyProperties(courseBase,coursePub);</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="comment">//根据课程id查询course_pic</span></span><br><span class="line">     Optional&lt;CoursePic&gt; picOptional = coursePicRepository.findById(id);</span><br><span class="line">     <span class="keyword">if</span> (picOptional.isPresent())&#123;</span><br><span class="line">         CoursePic coursePic = picOptional.get();</span><br><span class="line">         BeanUtils.copyProperties(coursePic,coursePub);</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="comment">//课程营销信息</span></span><br><span class="line">     Optional&lt;CourseMarket&gt; marketOptional = courseMarketRepository.findById(id);</span><br><span class="line">     <span class="keyword">if</span> (marketOptional.isPresent())&#123;</span><br><span class="line">         CourseMarket courseMarket = marketOptional.get();</span><br><span class="line">         BeanUtils.copyProperties(courseMarket,coursePub);</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="comment">//课程计划信息</span></span><br><span class="line">     TeachplanNode teachplanNode = teachplanMapper.selectList(id);</span><br><span class="line">     String jsonString = JSON.toJSONString(teachplanNode);</span><br><span class="line">     <span class="comment">//将课程计划信息Json串保存到coursePub中</span></span><br><span class="line">     coursePub.setTeachplan(jsonString);</span><br><span class="line">     <span class="keyword">return</span> coursePub;</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="comment">//将coursePub对象保存到数据库</span></span><br><span class="line"> <span class="function"><span class="keyword">private</span> CoursePub <span class="title">saveCoursePub</span><span class="params">(String id,CoursePub coursePub)</span></span>&#123;</span><br><span class="line">     CoursePub coursePubNEW=<span class="keyword">new</span> CoursePub();</span><br><span class="line">     <span class="comment">//根据课程id查询coursePub</span></span><br><span class="line">     Optional&lt;CoursePub&gt; pubOptional = coursePubRepository.findById(id);</span><br><span class="line">     <span class="keyword">if</span> (pubOptional.isPresent())&#123;</span><br><span class="line">         coursePubNEW=pubOptional.get();</span><br><span class="line">     &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">         coursePubNEW=<span class="keyword">new</span> CoursePub();</span><br><span class="line">     &#125;</span><br><span class="line">     BeanUtils.copyProperties(coursePub,coursePubNEW);</span><br><span class="line">     coursePubNEW.setId(id);</span><br><span class="line">     <span class="comment">//时间戳</span></span><br><span class="line">     coursePubNEW.setTimestamp(<span class="keyword">new</span> Date());</span><br><span class="line">     <span class="comment">//发布时间</span></span><br><span class="line">     SimpleDateFormat simpleDateFormat=<span class="keyword">new</span> SimpleDateFormat(<span class="string">"YYYY-MM-dd HH:mm:ss"</span>);</span><br><span class="line">     String date=simpleDateFormat.format(<span class="keyword">new</span> Date());</span><br><span class="line">     coursePubNEW.setPubTime(date);</span><br><span class="line">     coursePubRepository.save(coursePubNEW);</span><br><span class="line">     <span class="keyword">return</span> coursePubNEW;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h4 id="3-3-搭建ES环境"><a href="#3-3-搭建ES环境" class="headerlink" title="3.3 搭建ES环境"></a>3.3 搭建ES环境</h4><h5 id="3-3-1-ES启动"><a href="#3-3-1-ES启动" class="headerlink" title="3.3.1 ES启动"></a>3.3.1 ES启动</h5><ol>
<li>启动elasticsearch.bat, 运行elasticsearch</li>
<li>进入elasticsearch-head-master文件夹, 运行命令行<code>npm run stat</code>启动elasticsearch-head-master</li>
<li>访问 <span class="exturl" data-url="aHR0cDovL2xvY2FsaG9zdDo5MTAwLw==">http://localhost:9100/<i class="fa fa-external-link-alt"></i></span><h5 id="3-3-2-创建索引库"><a href="#3-3-2-创建索引库" class="headerlink" title="3.3.2 创建索引库"></a>3.3.2 创建索引库</h5>创建索引库<br>创建xc_course索引库，一个分片，0个副本。 <h5 id="3-3-3-创建映射"><a href="#3-3-3-创建映射" class="headerlink" title="3.3.3 创建映射"></a>3.3.3 创建映射</h5>Post  <span class="exturl" data-url="aHR0cDovL2xvY2FsaG9zdDo5MjAwL3hjX2NvdXJzZS9kb2MvX21hcHBpbmc=">http://localhost:9200/xc_course/doc/_mapping<i class="fa fa-external-link-alt"></i></span><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	<span class="attr">"properties"</span>: &#123;</span><br><span class="line">		<span class="attr">"description"</span>: &#123;</span><br><span class="line">			<span class="attr">"analyzer"</span>: <span class="string">"ik_max_word"</span>,</span><br><span class="line">			<span class="attr">"search_analyzer"</span>: <span class="string">"ik_smart"</span>,</span><br><span class="line">			<span class="attr">"type"</span>: <span class="string">"text"</span></span><br><span class="line">		&#125;,</span><br><span class="line">		<span class="attr">"grade"</span>: &#123;</span><br><span class="line">			<span class="attr">"type"</span>: <span class="string">"keyword"</span></span><br><span class="line">		&#125;,</span><br><span class="line">		<span class="attr">"id"</span>: &#123;</span><br><span class="line">			<span class="attr">"type"</span>: <span class="string">"keyword"</span></span><br><span class="line">		&#125;,</span><br><span class="line">		<span class="attr">"mt"</span>: &#123;</span><br><span class="line">			<span class="attr">"type"</span>: <span class="string">"keyword"</span></span><br><span class="line">		&#125;,</span><br><span class="line">		<span class="attr">"name"</span>: &#123;</span><br><span class="line">			<span class="attr">"analyzer"</span>: <span class="string">"ik_max_word"</span>,</span><br><span class="line">			<span class="attr">"search_analyzer"</span>: <span class="string">"ik_smart"</span>,</span><br><span class="line">			<span class="attr">"type"</span>: <span class="string">"text"</span></span><br><span class="line">		&#125;,</span><br><span class="line">		<span class="attr">"users"</span>: &#123;</span><br><span class="line">			<span class="attr">"index"</span>: <span class="literal">false</span>,</span><br><span class="line">			<span class="attr">"type"</span>: <span class="string">"text"</span></span><br><span class="line">		&#125;,</span><br><span class="line">		<span class="attr">"charge"</span>: &#123;</span><br><span class="line">			<span class="attr">"type"</span>: <span class="string">"keyword"</span></span><br><span class="line">		&#125;,</span><br><span class="line">		<span class="attr">"valid"</span>: &#123;</span><br><span class="line">			<span class="attr">"type"</span>: <span class="string">"keyword"</span></span><br><span class="line">		&#125;,</span><br><span class="line">		<span class="attr">"pic"</span>: &#123;</span><br><span class="line">			<span class="attr">"index"</span>: <span class="literal">false</span>,</span><br><span class="line">			<span class="attr">"type"</span>: <span class="string">"keyword"</span></span><br><span class="line">		&#125;,</span><br><span class="line">		<span class="attr">"qq"</span>: &#123;</span><br><span class="line">			<span class="attr">"index"</span>: <span class="literal">false</span>,</span><br><span class="line">			<span class="attr">"type"</span>: <span class="string">"keyword"</span></span><br><span class="line">		&#125;,</span><br><span class="line">		<span class="attr">"price"</span>: &#123;</span><br><span class="line">			<span class="attr">"type"</span>: <span class="string">"float"</span></span><br><span class="line">		&#125;,</span><br><span class="line">		<span class="attr">"price_old"</span>: &#123;</span><br><span class="line">			<span class="attr">"type"</span>: <span class="string">"float"</span></span><br><span class="line">		&#125;,</span><br><span class="line">		<span class="attr">"st"</span>: &#123;</span><br><span class="line">			<span class="attr">"type"</span>: <span class="string">"keyword"</span></span><br><span class="line">		&#125;,</span><br><span class="line">		<span class="attr">"status"</span>: &#123;</span><br><span class="line">			<span class="attr">"type"</span>: <span class="string">"keyword"</span></span><br><span class="line">		&#125;,</span><br><span class="line">		<span class="attr">"studymodel"</span>: &#123;</span><br><span class="line">			<span class="attr">"type"</span>: <span class="string">"keyword"</span></span><br><span class="line">		&#125;,</span><br><span class="line">		<span class="attr">"teachmode"</span>: &#123;</span><br><span class="line">			<span class="attr">"type"</span>: <span class="string">"keyword"</span></span><br><span class="line">		&#125;,</span><br><span class="line">		<span class="attr">"teachplan"</span>: &#123;</span><br><span class="line">			<span class="attr">"analyzer"</span>: <span class="string">"ik_max_word"</span>,</span><br><span class="line">			<span class="attr">"search_analyzer"</span>: <span class="string">"ik_smart"</span>,</span><br><span class="line">			<span class="attr">"type"</span>: <span class="string">"text"</span></span><br><span class="line">		&#125;,</span><br><span class="line">		<span class="attr">"expires"</span>: &#123;</span><br><span class="line">			<span class="attr">"type"</span>: <span class="string">"date"</span>,</span><br><span class="line">			<span class="attr">"format"</span>: <span class="string">"yyyy‐MM‐ddHH:mm:ss"</span></span><br><span class="line">		&#125;,</span><br><span class="line">		<span class="attr">"pub_time"</span>: &#123;</span><br><span class="line">			<span class="attr">"type"</span>: <span class="string">"date"</span>,</span><br><span class="line">			<span class="attr">"format"</span>: <span class="string">"yyyy‐MM‐ddHH:mm:ss"</span></span><br><span class="line">		&#125;,</span><br><span class="line">		<span class="attr">"start_time"</span>: &#123;</span><br><span class="line">			<span class="attr">"type"</span>: <span class="string">"date"</span>,</span><br><span class="line">			<span class="attr">"format"</span>: <span class="string">"yyyy‐MM‐ddHH:mm:ss"</span></span><br><span class="line">		&#125;,</span><br><span class="line">		<span class="attr">"end_time"</span>: &#123;</span><br><span class="line">			<span class="attr">"type"</span>: <span class="string">"date"</span>,</span><br><span class="line">			<span class="attr">"format"</span>: <span class="string">"yyyy‐MM‐ddHH:mm:ss"</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h4 id="3-4-Logstash创建索引"><a href="#3-4-Logstash创建索引" class="headerlink" title="3.4 Logstash创建索引"></a>3.4 Logstash创建索引</h4><p>Logstash是ES下的一款开源软件，它能够同时从多个来源采集数据、转换数据，然后将数据发送到Eleasticsearch 中创建索引。<br>本项目使用Logstash将MySQL中的数据采用到ES索引中。</p>
<h5 id="3-4-1-创建模板文件"><a href="#3-4-1-创建模板文件" class="headerlink" title="3.4.1  创建模板文件"></a>3.4.1  创建模板文件</h5><p>Logstash的工作是从MySQL中读取数据，向ES中创建索引，这里需要提前创建mapping的模板文件以便logstash 使用。<br>在logstach的conﬁg目录创建xc_course_template.json，内容如下：<br>本教程的xc_course_template.json目录是：D:/ElasticSearch/logstash-6.2.1/conﬁg/xc_course_template.json</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">   <span class="attr">"mappings"</span> : &#123;</span><br><span class="line">      <span class="attr">"doc"</span> : &#123;</span><br><span class="line">         <span class="attr">"properties"</span> : &#123;</span><br><span class="line">            <span class="attr">"charge"</span> : &#123;</span><br><span class="line">               <span class="attr">"type"</span> : <span class="string">"keyword"</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">"description"</span> : &#123;</span><br><span class="line">               <span class="attr">"analyzer"</span> : <span class="string">"ik_max_word"</span>,</span><br><span class="line">               <span class="attr">"search_analyzer"</span> : <span class="string">"ik_smart"</span>,</span><br><span class="line">               <span class="attr">"type"</span> : <span class="string">"text"</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">"end_time"</span> : &#123;</span><br><span class="line">               <span class="attr">"format"</span> : <span class="string">"yyyy-MM-dd HH:mm:ss"</span>,</span><br><span class="line">               <span class="attr">"type"</span> : <span class="string">"date"</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">"expires"</span> : &#123;</span><br><span class="line">               <span class="attr">"format"</span> : <span class="string">"yyyy-MM-dd HH:mm:ss"</span>,</span><br><span class="line">               <span class="attr">"type"</span> : <span class="string">"date"</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">"grade"</span> : &#123;</span><br><span class="line">               <span class="attr">"type"</span> : <span class="string">"keyword"</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">"id"</span> : &#123;</span><br><span class="line">               <span class="attr">"type"</span> : <span class="string">"keyword"</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">"mt"</span> : &#123;</span><br><span class="line">               <span class="attr">"type"</span> : <span class="string">"keyword"</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">"name"</span> : &#123;</span><br><span class="line">               <span class="attr">"analyzer"</span> : <span class="string">"ik_max_word"</span>,</span><br><span class="line">               <span class="attr">"search_analyzer"</span> : <span class="string">"ik_smart"</span>,</span><br><span class="line">               <span class="attr">"type"</span> : <span class="string">"text"</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">"pic"</span> : &#123;</span><br><span class="line">               <span class="attr">"index"</span> : <span class="literal">false</span>,</span><br><span class="line">               <span class="attr">"type"</span> : <span class="string">"keyword"</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">"price"</span> : &#123;</span><br><span class="line">               <span class="attr">"type"</span> : <span class="string">"float"</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">"price_old"</span> : &#123;</span><br><span class="line">               <span class="attr">"type"</span> : <span class="string">"float"</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">"pub_time"</span> : &#123;</span><br><span class="line">               <span class="attr">"format"</span> : <span class="string">"yyyy-MM-dd HH:mm:ss"</span>,</span><br><span class="line">               <span class="attr">"type"</span> : <span class="string">"date"</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">"qq"</span> : &#123;</span><br><span class="line">               <span class="attr">"index"</span> : <span class="literal">false</span>,</span><br><span class="line">               <span class="attr">"type"</span> : <span class="string">"keyword"</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">"st"</span> : &#123;</span><br><span class="line">               <span class="attr">"type"</span> : <span class="string">"keyword"</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">"start_time"</span> : &#123;</span><br><span class="line">               <span class="attr">"format"</span> : <span class="string">"yyyy-MM-dd HH:mm:ss"</span>,</span><br><span class="line">               <span class="attr">"type"</span> : <span class="string">"date"</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">"status"</span> : &#123;</span><br><span class="line">               <span class="attr">"type"</span> : <span class="string">"keyword"</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">"studymodel"</span> : &#123;</span><br><span class="line">               <span class="attr">"type"</span> : <span class="string">"keyword"</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">"teachmode"</span> : &#123;</span><br><span class="line">               <span class="attr">"type"</span> : <span class="string">"keyword"</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">"teachplan"</span> : &#123;</span><br><span class="line">               <span class="attr">"analyzer"</span> : <span class="string">"ik_max_word"</span>,</span><br><span class="line">               <span class="attr">"search_analyzer"</span> : <span class="string">"ik_smart"</span>,</span><br><span class="line">               <span class="attr">"type"</span> : <span class="string">"text"</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">"users"</span> : &#123;</span><br><span class="line">               <span class="attr">"index"</span> : <span class="literal">false</span>,</span><br><span class="line">               <span class="attr">"type"</span> : <span class="string">"text"</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">"valid"</span> : &#123;</span><br><span class="line">               <span class="attr">"type"</span> : <span class="string">"keyword"</span></span><br><span class="line">            &#125;</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;,</span><br><span class="line">   <span class="attr">"template"</span> : <span class="string">"xc_course"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="3-4-2-配置mysql-conf"><a href="#3-4-2-配置mysql-conf" class="headerlink" title="3.4.2 配置mysql.conf"></a>3.4.2 配置mysql.conf</h5><p>在logstash的conﬁg目录下配置mysql.conf文件供logstash使用，logstash会根据mysql.conf文件的配置的地址从 MySQL中读取数据向ES中写入索引。 </p>
<blockquote>
<p> 参考 <span class="exturl" data-url="aHR0cHM6Ly93d3cuZWxhc3RpYy5jby9ndWlkZS9lbi9sb2dzdGFzaC9jdXJyZW50L3BsdWdpbnMtaW5wdXRzLWpkYmMuaHRtbA==">https://www.elastic.co/guide/en/logstash/current/plugins-inputs-jdbc.html<i class="fa fa-external-link-alt"></i></span> 配置输入数据源和输出数据源。<br>说明：</p>
</blockquote>
<figure class="highlight puppet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">input</span> &#123;</span><br><span class="line">  stdin &#123;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">jdbc</span> &#123;</span><br><span class="line">  <span class="attr">jdbc_connection_string</span> =&gt; <span class="string">"jdbc:mysql://localhost:3306/xc_course?useUnicode=true&amp;characterEncoding=utf-8&amp;useSSL=true&amp;serverTimezone=UTC"</span></span><br><span class="line">  <span class="comment"># the user we wish to excute our statement as</span></span><br><span class="line">  <span class="attr">jdbc_user</span> =&gt; <span class="string">"root"</span></span><br><span class="line">  <span class="attr">jdbc_password</span> =&gt; <span class="string">"xxxxxxx"</span></span><br><span class="line">  <span class="comment"># the path to our downloaded jdbc driver  </span></span><br><span class="line">  <span class="attr">jdbc_driver_library</span> =&gt; <span class="string">"E:/tools/maven/maven_repository/mysql/mysql-connector-java/5.1.6/mysql-connector-java-5.1.6.jar"</span></span><br><span class="line">  <span class="comment"># the name of the driver class for mysql</span></span><br><span class="line">  <span class="attr">jdbc_driver_class</span> =&gt; <span class="string">"com.mysql.jdbc.Driver"</span></span><br><span class="line">  <span class="attr">jdbc_paging_enabled</span> =&gt; <span class="string">"true"</span></span><br><span class="line">  <span class="attr">jdbc_page_size</span> =&gt; <span class="string">"50000"</span></span><br><span class="line">  <span class="comment">#要执行的sql文件</span></span><br><span class="line">  <span class="comment">#statement_filepath =&gt; "/conf/course.sql"</span></span><br><span class="line">  <span class="attr">statement</span> =&gt; <span class="string">"select * from course_pub"</span></span><br><span class="line">  <span class="comment">#定时配置</span></span><br><span class="line">  <span class="attr">schedule</span> =&gt; <span class="string">"* * * * *"</span></span><br><span class="line">  <span class="attr">record_last_run</span> =&gt; <span class="keyword">true</span></span><br><span class="line">  <span class="attr">last_run_metadata_path</span> =&gt; <span class="string">"E:/tools/elasticsearch/logstash-6.5.4/config/logstash_metadata"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">output</span> &#123;</span><br><span class="line">  elasticsearch &#123;</span><br><span class="line">  <span class="comment">#ES的ip地址和端口</span></span><br><span class="line">  <span class="attr">hosts</span> =&gt; <span class="string">"localhost:9200"</span></span><br><span class="line">  <span class="comment">#hosts =&gt; ["localhost:9200","localhost:9202","localhost:9203"]</span></span><br><span class="line">  <span class="comment">#ES索引库名称</span></span><br><span class="line">  <span class="attr">index</span> =&gt; <span class="string">"xc_course"</span></span><br><span class="line">  <span class="attr">document_id</span> =&gt; <span class="string">"%&#123;id&#125;"</span></span><br><span class="line">  <span class="attr">document_type</span> =&gt; <span class="string">"doc"</span></span><br><span class="line">  <span class="attr">template</span> =&gt;<span class="string">"E:/tools/elasticsearch/logstash-6.5.4/config/xc_course_template.json"</span></span><br><span class="line">  <span class="attr">template_name</span> =&gt;<span class="string">"xc_course"</span></span><br><span class="line">  <span class="attr">template_overwrite</span> =&gt;<span class="string">"true"</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">stdout</span> &#123;</span><br><span class="line"> <span class="comment">#日志输出</span></span><br><span class="line">  <span class="attr">codec</span> =&gt; json_lines</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li>ES采用UTC时区问题 ES采用UTC 时区，比北京时间早8小时，所以ES读取数据时让最后更新时间加8小时 where timestamp &gt; date_add(:sql_last_value,INTERVAL 8 HOUR)</li>
<li>logstash每个执行完成会在指定目录文件中记录执行时间下次以此时间为基准进行增量同步数据到索引库。<h5 id="3-4-3-测试"><a href="#3-4-3-测试" class="headerlink" title="3.4.3 测试"></a>3.4.3 测试</h5>启动logstash.bat：<code>.\logstash.bat -f  ..\config\mysql.conf</code><h3 id="4-课程搜索"><a href="#4-课程搜索" class="headerlink" title="4 课程搜索"></a>4 课程搜索</h3><h4 id="4-1-需求分析"><a href="#4-1-需求分析" class="headerlink" title="4.1 需求分析"></a>4.1 需求分析</h4><img data-src="../../../../assets/img/203828.jpg" alt></li>
<li>根据分类搜索课程信息。</li>
<li>根据关键字搜索课程信息，搜索方式为全文检索，关键字需要匹配课程的名称、 课程内容。 </li>
<li>根据难度等级搜索课程。</li>
<li>搜索结点分页显示。</li>
</ol>
<p><strong>技术分析：</strong></p>
<ol>
<li><p>根据关键字搜索，采用MultiMatchQuery，搜索name、description、teachplan</p>
</li>
<li><p>根据分类、课程等级搜索采用过滤器实现。 </p>
</li>
<li><p>分页查询。</p>
</li>
<li><p>高亮显示。 </p>
<h4 id="4-2-创建搜索服务工程"><a href="#4-2-创建搜索服务工程" class="headerlink" title="4.2 创建搜索服务工程"></a>4.2 创建搜索服务工程</h4></li>
<li><p>创建xc-service-search工程<br> <img data-src="../../../../assets/img/210014.jpg" alt></p>
</li>
<li><p>配置<br> 配置appliction.yml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="string">$&#123;port:40100&#125;</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">xc-search-service</span></span><br><span class="line"><span class="attr">xuecheng:</span></span><br><span class="line">  <span class="attr">elasticsearch:</span></span><br><span class="line">    <span class="attr">hostlist:</span> <span class="string">$&#123;eshostlist:127.0.0.1:9200&#125;</span> <span class="comment">#多个结点中间用逗号分隔</span></span><br><span class="line">    <span class="attr">course:</span></span><br><span class="line">      <span class="attr">index:</span> <span class="string">xc_course</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">doc</span></span><br></pre></td></tr></table></figure>

<p>配置RestHighLevelClient和RestClient (ElasticsearchConfig)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ElasticsearchConfig</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;xuecheng.elasticsearch.hostlist&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String hostlist;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RestHighLevelClient <span class="title">restHighLevelClient</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="comment">//解析hostlist配置信息</span></span><br><span class="line">        String[] split = hostlist.split(<span class="string">","</span>);</span><br><span class="line">        <span class="comment">//创建HttpHost数组，其中存放es主机和端口的配置信息</span></span><br><span class="line">        HttpHost[] httpHostArray = <span class="keyword">new</span> HttpHost[split.length];</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;split.length;i++)&#123;</span><br><span class="line">            String item = split[i];</span><br><span class="line">            httpHostArray[i] = <span class="keyword">new</span> HttpHost(item.split(<span class="string">":"</span>)[<span class="number">0</span>], Integer.parseInt(item.split(<span class="string">":"</span>)[<span class="number">1</span>]), <span class="string">"http"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//创建RestHighLevelClient客户端</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> RestHighLevelClient(RestClient.builder(httpHostArray));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//项目主要使用RestHighLevelClient，对于低级的客户端暂时不用</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RestClient <span class="title">restClient</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="comment">//解析hostlist配置信息</span></span><br><span class="line">        String[] split = hostlist.split(<span class="string">","</span>);</span><br><span class="line">        <span class="comment">//创建HttpHost数组，其中存放es主机和端口的配置信息</span></span><br><span class="line">        HttpHost[] httpHostArray = <span class="keyword">new</span> HttpHost[split.length];</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;split.length;i++)&#123;</span><br><span class="line">            String item = split[i];</span><br><span class="line">            httpHostArray[i] = <span class="keyword">new</span> HttpHost(item.split(<span class="string">":"</span>)[<span class="number">0</span>], Integer.parseInt(item.split(<span class="string">":"</span>)[<span class="number">1</span>]), <span class="string">"http"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> RestClient.builder(httpHostArray).build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h4 id="4-3-API"><a href="#4-3-API" class="headerlink" title="4.3 API"></a>4.3 API</h4><p>xc-service-api 工程下的 com.xuecheng.api.search.EsCourseControllerApi</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Api</span>(value = <span class="string">"课程搜索接口"</span>,description = <span class="string">"提供课程搜索功能"</span>,tags = &#123;<span class="string">"课程搜索"</span>&#125;)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">EsCourseControllerApi</span> </span>&#123;</span><br><span class="line">    <span class="meta">@ApiOperation</span>(<span class="string">"课程综合搜索"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> QueryResponseResult&lt;CoursePub&gt; <span class="title">list</span><span class="params">(<span class="keyword">int</span> page, <span class="keyword">int</span> size, CourseSearchParam courseSearchParam)</span><span class="keyword">throws</span> IOException</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="4-4-Service"><a href="#4-4-Service" class="headerlink" title="4.4 Service"></a>4.4 Service</h4><p>Service方法代码复杂，这里分三步完成。 </p>
<h5 id="4-4-1-按关键字搜索"><a href="#4-4-1-按关键字搜索" class="headerlink" title="4.4.1 按关键字搜索"></a>4.4.1 按关键字搜索</h5><ol>
<li><p>在appliction.yml中配置source_ﬁeld</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="string">$&#123;port:40100&#125;</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">xc-search-service</span></span><br><span class="line"><span class="attr">xuecheng:</span></span><br><span class="line">  <span class="attr">elasticsearch:</span></span><br><span class="line">    <span class="attr">hostlist:</span> <span class="string">$&#123;eshostlist:127.0.0.1:9200&#125;</span> <span class="comment">#多个结点中间用逗号分隔</span></span><br><span class="line">    <span class="attr">course:</span></span><br><span class="line">      <span class="attr">index:</span> <span class="string">xc_course</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">doc</span></span><br><span class="line">      <span class="attr">source_field:</span> <span class="string">id,name,grade,mt,st,charge,valid,pic,qq,price,price_old,status,studymodel,teachmode,expires,pub_</span> <span class="string">time,start_time,end_time</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>service完整代码如下 </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EsCourseService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;xuecheng.elasticsearch.course.index&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String index;</span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;xuecheng.elasticsearch.course.type&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String type;</span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;xuecheng.elasticsearch.course.source_field&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String source_field;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    RestHighLevelClient restHighLevelClient;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//课程综合搜索</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> QueryResponseResult&lt;CoursePub&gt; <span class="title">list</span><span class="params">(<span class="keyword">int</span> page, <span class="keyword">int</span> size, CourseSearchParam courseSearchParam)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (courseSearchParam == <span class="keyword">null</span>) &#123;</span><br><span class="line">            courseSearchParam = <span class="keyword">new</span> CourseSearchParam();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//创建搜索请求对象</span></span><br><span class="line">        SearchRequest searchRequest = <span class="keyword">new</span> SearchRequest(index);</span><br><span class="line">        <span class="comment">//设置搜索类型</span></span><br><span class="line">        searchRequest.types(type);</span><br><span class="line">        SearchSourceBuilder searchSourceBuilder = <span class="keyword">new</span> SearchSourceBuilder();</span><br><span class="line">        <span class="comment">//过滤源字段</span></span><br><span class="line">        String[] split_source_field = source_field.split(<span class="string">","</span>);</span><br><span class="line">        searchSourceBuilder.fetchSource(split_source_field, <span class="keyword">new</span> String[]&#123;&#125;);</span><br><span class="line">        <span class="comment">//创建布尔查询对象</span></span><br><span class="line">        BoolQueryBuilder boolQueryBuilder = QueryBuilders.boolQuery();</span><br><span class="line">        <span class="comment">//搜索条件</span></span><br><span class="line">        <span class="comment">//根据关键字搜索</span></span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isNotEmpty(courseSearchParam.getKeyword())) &#123;</span><br><span class="line">            MultiMatchQueryBuilder multiMatchQueryBuilder = QueryBuilders.multiMatchQuery(courseSearchParam.getKeyword(), <span class="string">"name"</span>, <span class="string">"description"</span>, <span class="string">"teachplan"</span>)</span><br><span class="line">                    .minimumShouldMatch(<span class="string">"70%"</span>)</span><br><span class="line">                    .field(<span class="string">"name"</span>, <span class="number">10</span>);</span><br><span class="line">            boolQueryBuilder.must(multiMatchQueryBuilder);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//设置布尔查询到searchSourceBuilder</span></span><br><span class="line">        searchSourceBuilder.query(boolQueryBuilder);</span><br><span class="line">        searchRequest.source(searchSourceBuilder);</span><br><span class="line"></span><br><span class="line">        QueryResult&lt;CoursePub&gt; queryResult = <span class="keyword">new</span> QueryResult&lt;&gt;();</span><br><span class="line">        List&lt;CoursePub&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//执行搜索</span></span><br><span class="line">            SearchResponse search = restHighLevelClient.search(searchRequest);</span><br><span class="line">            SearchHits searchHits = search.getHits();</span><br><span class="line">            <span class="comment">//匹配的总记录数</span></span><br><span class="line">            <span class="keyword">long</span> totalHits = searchHits.totalHits;</span><br><span class="line">            queryResult.setTotal(totalHits);</span><br><span class="line">            SearchHit[] hits = searchHits.getHits();</span><br><span class="line">            <span class="keyword">for</span> (SearchHit hit : hits) &#123;</span><br><span class="line">                CoursePub coursePub = <span class="keyword">new</span> CoursePub();</span><br><span class="line">                <span class="comment">//源文档</span></span><br><span class="line">                Map&lt;String, Object&gt; sourceAsMap = hit.getSourceAsMap();</span><br><span class="line">                coursePub.setName((String) sourceAsMap.get(<span class="string">"name"</span>));</span><br><span class="line">                coursePub.setPic((String) sourceAsMap.get(<span class="string">"pic"</span>));</span><br><span class="line">                Double price = <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">if</span> (sourceAsMap.get(<span class="string">"price"</span>)!=<span class="keyword">null</span>)&#123;</span><br><span class="line">                    price= (Double) sourceAsMap.get(<span class="string">"price"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                coursePub.setPrice(price);</span><br><span class="line">                Double price_old = <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">if</span> (sourceAsMap.get(<span class="string">"price_old"</span>)!=<span class="keyword">null</span>)&#123;</span><br><span class="line">                    price_old= (Double) sourceAsMap.get(<span class="string">"price_old"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                coursePub.setPrice(price);</span><br><span class="line">                coursePub.setPrice_old(price_old);</span><br><span class="line">                list.add(coursePub);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        queryResult.setList(list);</span><br><span class="line">        QueryResponseResult&lt;CoursePub&gt; queryResponseResult = <span class="keyword">new</span> QueryResponseResult&lt;CoursePub&gt;(CommonCode.SUCCESS,queryResult);</span><br><span class="line">        <span class="keyword">return</span> queryResponseResult;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h5 id="4-4-2-按分类和难度等级搜索"><a href="#4-4-2-按分类和难度等级搜索" class="headerlink" title="4.4.2 按分类和难度等级搜索"></a>4.4.2 按分类和难度等级搜索</h5><p>按分类和难度等级搜索代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//根据一级分类搜索</span></span><br><span class="line"><span class="keyword">if</span> (StringUtils.isNotEmpty(courseSearchParam.getMt()))&#123;</span><br><span class="line">    boolQueryBuilder.filter(QueryBuilders.termQuery(<span class="string">"mt"</span>,courseSearchParam.getMt()));</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//根据二级分类搜索</span></span><br><span class="line"><span class="keyword">if</span> (StringUtils.isNotEmpty(courseSearchParam.getSt()))&#123;</span><br><span class="line">    boolQueryBuilder.filter(QueryBuilders.termQuery(<span class="string">"st"</span>,courseSearchParam.getSt()));</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//根据难度等级搜索</span></span><br><span class="line"><span class="keyword">if</span> (StringUtils.isNotEmpty(courseSearchParam.getGrade()))&#123;</span><br><span class="line">    boolQueryBuilder.filter(QueryBuilders.termQuery(<span class="string">"grade"</span>,courseSearchParam.getGrade()));</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//设置布尔查询到searchSourceBuilder</span></span><br><span class="line">searchSourceBuilder.query(boolQueryBuilder);</span><br><span class="line">searchRequest.source(searchSourceBuilder);</span><br></pre></td></tr></table></figure>

<h5 id="4-4-3-分页与高亮"><a href="#4-4-3-分页与高亮" class="headerlink" title="4.4.3 分页与高亮"></a>4.4.3 分页与高亮</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EsCourseService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;xuecheng.elasticsearch.course.index&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String index;</span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;xuecheng.elasticsearch.course.type&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String type;</span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;xuecheng.elasticsearch.course.source_field&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String source_field;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    RestHighLevelClient restHighLevelClient;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//课程综合搜索</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> QueryResponseResult&lt;CoursePub&gt; <span class="title">list</span><span class="params">(<span class="keyword">int</span> page, <span class="keyword">int</span> size, CourseSearchParam courseSearchParam)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (courseSearchParam == <span class="keyword">null</span>) &#123;</span><br><span class="line">            courseSearchParam = <span class="keyword">new</span> CourseSearchParam();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//创建搜索请求对象</span></span><br><span class="line">        SearchRequest searchRequest = <span class="keyword">new</span> SearchRequest(index);</span><br><span class="line">        <span class="comment">//设置搜索类型</span></span><br><span class="line">        searchRequest.types(type);</span><br><span class="line">        SearchSourceBuilder searchSourceBuilder = <span class="keyword">new</span> SearchSourceBuilder();</span><br><span class="line">        <span class="comment">//过滤源字段</span></span><br><span class="line">        String[] split_source_field = source_field.split(<span class="string">","</span>);</span><br><span class="line">        searchSourceBuilder.fetchSource(split_source_field, <span class="keyword">new</span> String[]&#123;&#125;);</span><br><span class="line">        <span class="comment">//创建布尔查询对象</span></span><br><span class="line">        BoolQueryBuilder boolQueryBuilder = QueryBuilders.boolQuery();</span><br><span class="line">        <span class="comment">//搜索条件</span></span><br><span class="line">        <span class="comment">//根据关键字搜索</span></span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isNotEmpty(courseSearchParam.getKeyword())) &#123;</span><br><span class="line">            MultiMatchQueryBuilder multiMatchQueryBuilder = QueryBuilders.multiMatchQuery(courseSearchParam.getKeyword(), <span class="string">"name"</span>, <span class="string">"description"</span>, <span class="string">"teachplan"</span>)</span><br><span class="line">                    .minimumShouldMatch(<span class="string">"70%"</span>)</span><br><span class="line">                    .field(<span class="string">"name"</span>, <span class="number">10</span>);</span><br><span class="line">            boolQueryBuilder.must(multiMatchQueryBuilder);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//根据一级分类搜索</span></span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isNotEmpty(courseSearchParam.getMt()))&#123;</span><br><span class="line">            boolQueryBuilder.filter(QueryBuilders.termQuery(<span class="string">"mt"</span>,courseSearchParam.getMt()));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//根据二级分类搜索</span></span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isNotEmpty(courseSearchParam.getSt()))&#123;</span><br><span class="line">            boolQueryBuilder.filter(QueryBuilders.termQuery(<span class="string">"st"</span>,courseSearchParam.getSt()));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//根据难度等级搜索</span></span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isNotEmpty(courseSearchParam.getGrade()))&#123;</span><br><span class="line">            boolQueryBuilder.filter(QueryBuilders.termQuery(<span class="string">"grade"</span>,courseSearchParam.getGrade()));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//分页</span></span><br><span class="line">        <span class="keyword">if</span> (page&lt;=<span class="number">0</span>)&#123;</span><br><span class="line">            page=<span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (size&lt;=<span class="number">0</span>)&#123;</span><br><span class="line">            size=<span class="number">20</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">int</span> start=(page-<span class="number">1</span>)*size;</span><br><span class="line">        searchSourceBuilder.from(start);</span><br><span class="line">        searchSourceBuilder.size(size);</span><br><span class="line">        <span class="comment">//设置布尔查询到searchSourceBuilder</span></span><br><span class="line">        searchSourceBuilder.query(boolQueryBuilder);</span><br><span class="line">        <span class="comment">//高亮设置</span></span><br><span class="line">        HighlightBuilder highlightBuilder=<span class="keyword">new</span> HighlightBuilder();</span><br><span class="line">        highlightBuilder.preTags(<span class="string">"&lt;font class='eslight'&gt;"</span>);</span><br><span class="line">        highlightBuilder.postTags(<span class="string">"&lt;/font&gt;"</span>);</span><br><span class="line">        <span class="comment">//设置高亮字段</span></span><br><span class="line">        highlightBuilder.fields().add(<span class="keyword">new</span> HighlightBuilder.Field(<span class="string">"name"</span>));</span><br><span class="line">        searchSourceBuilder.highlighter(highlightBuilder);</span><br><span class="line">        searchRequest.source(searchSourceBuilder);</span><br><span class="line"></span><br><span class="line">        QueryResult&lt;CoursePub&gt; queryResult = <span class="keyword">new</span> QueryResult&lt;&gt;();</span><br><span class="line">        List&lt;CoursePub&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//执行搜索</span></span><br><span class="line">            SearchResponse search = restHighLevelClient.search(searchRequest);</span><br><span class="line">            SearchHits searchHits = search.getHits();</span><br><span class="line">            <span class="comment">//匹配的总记录数</span></span><br><span class="line">            <span class="keyword">long</span> totalHits = searchHits.totalHits;</span><br><span class="line">            queryResult.setTotal(totalHits);</span><br><span class="line">            SearchHit[] hits = searchHits.getHits();</span><br><span class="line">            <span class="keyword">for</span> (SearchHit hit : hits) &#123;</span><br><span class="line">                CoursePub coursePub = <span class="keyword">new</span> CoursePub();</span><br><span class="line">                <span class="comment">//源文档</span></span><br><span class="line">                Map&lt;String, Object&gt; sourceAsMap = hit.getSourceAsMap();</span><br><span class="line">                String name = (String) sourceAsMap.get(<span class="string">"name"</span>);</span><br><span class="line">                <span class="comment">//取出高亮字段</span></span><br><span class="line">                Map&lt;String, HighlightField&gt; highlightFields = hit.getHighlightFields();</span><br><span class="line">                <span class="keyword">if</span> (highlightFields!=<span class="keyword">null</span>)&#123;</span><br><span class="line">                    HighlightField nameField = highlightFields.get(<span class="string">"name"</span>);</span><br><span class="line">                    <span class="keyword">if</span> (nameField!=<span class="keyword">null</span>)&#123;</span><br><span class="line">                        Text[] fragments = nameField.getFragments();</span><br><span class="line">                        StringBuffer stringBuffer=<span class="keyword">new</span> StringBuffer();</span><br><span class="line">                        <span class="keyword">for</span> (Text fragment : fragments) &#123;</span><br><span class="line">                            stringBuffer.append(fragment.string());</span><br><span class="line">                        &#125;</span><br><span class="line">                        name=stringBuffer.toString();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                coursePub.setName(name);</span><br><span class="line">                coursePub.setPic((String) sourceAsMap.get(<span class="string">"pic"</span>));</span><br><span class="line">                Double price = <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">if</span> (sourceAsMap.get(<span class="string">"price"</span>)!=<span class="keyword">null</span>)&#123;</span><br><span class="line">                    price= (Double) sourceAsMap.get(<span class="string">"price"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                coursePub.setPrice(price);</span><br><span class="line">                Double price_old = <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">if</span> (sourceAsMap.get(<span class="string">"price_old"</span>)!=<span class="keyword">null</span>)&#123;</span><br><span class="line">                    price_old= (Double) sourceAsMap.get(<span class="string">"price_old"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                coursePub.setPrice(price);</span><br><span class="line">                coursePub.setPrice_old(price_old);</span><br><span class="line">                list.add(coursePub);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        queryResult.setList(list);</span><br><span class="line">        QueryResponseResult&lt;CoursePub&gt; queryResponseResult = <span class="keyword">new</span> QueryResponseResult&lt;CoursePub&gt;(CommonCode.SUCCESS,queryResult);</span><br><span class="line">        <span class="keyword">return</span> queryResponseResult;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="4-5-Controller"><a href="#4-5-Controller" class="headerlink" title="4.5 Controller"></a>4.5 Controller</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/search/course"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EsCourseController</span> <span class="keyword">implements</span> <span class="title">EsCourseControllerApi</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    EsCourseService esCourseService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/list/&#123;page&#125;/&#123;size&#125;"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> QueryResponseResult&lt;CoursePub&gt; <span class="title">list</span><span class="params">(@PathVariable(<span class="string">"page"</span>)</span> <span class="keyword">int</span> page, @<span class="title">PathVariable</span><span class="params">(<span class="string">"size"</span>)</span> <span class="keyword">int</span> size, CourseSearchParam courseSearchParam) <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> esCourseService.list(page,size,courseSearchParam);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="4-6-测试"><a href="#4-6-测试" class="headerlink" title="4.6 测试"></a>4.6 测试</h4><p><span class="exturl" data-url="aHR0cDovL2xvY2FsaG9zdDo0MDEwMC9zd2FnZ2VyLXVpLmh0bWw=">http://localhost:40100/swagger-ui.html<i class="fa fa-external-link-alt"></i></span></p>
<p><img data-src="../../../../assets/img/211106.jpg" alt></p>

    </div>

    
    
    
        <div class="reward-container">
  <div>请作者喝瓶肥宅快乐水</div>
  <button onclick="var qr = document.getElementById('qr'); qr.style.display = (qr.style.display === 'none') ? 'block' : 'none';">
    打赏
  </button>
  <div id="qr" style="display: none;">
      
      <div style="display: inline-block;">
        <img src="/assets/img/vxpay.jpg" alt="liuwy1998 微信支付">
        <p>微信支付</p>
      </div>
      
      <div style="display: inline-block;">
        <img src="/assets/img/alipay.jpg" alt="liuwy1998 支付宝">
        <p>支付宝</p>
      </div>

  </div>
</div>


      <footer class="post-footer">
          
          <div class="post-tags">
              <a href="/tags/项目/" rel="tag"><i class="fa fa-tag"></i> 项目</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/42236/" rel="prev" title="学成在线(十一.ElasticSearch(一))">
      <i class="fa fa-chevron-left"></i> 学成在线(十一.ElasticSearch(一))
    </a></div>
      <div class="post-nav-item">
    <a href="/2642/" rel="next" title="学成在线(十二.ElasticSearch(二))">
      学成在线(十二.ElasticSearch(二)) <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-课程搜索需求分析"><span class="nav-text">1.课程搜索需求分析</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-1-需求分析"><span class="nav-text">1.1 需求分析</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-2-搜索流程"><span class="nav-text">1.2 搜索流程</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-全文检索技术研究"><span class="nav-text">2.全文检索技术研究</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-课程索引"><span class="nav-text">3.课程索引</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#3-1-技术方案"><span class="nav-text">3.1 技术方案</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-2-准备课程索引信息"><span class="nav-text">3.2 准备课程索引信息</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#3-2-1-创建课程发布表"><span class="nav-text">3.2.1 创建课程发布表</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3-2-2-创建课程发布表模型"><span class="nav-text">3.2.2 创建课程发布表模型</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3-2-3-修改课程发布"><span class="nav-text">3.2.3 修改课程发布</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-3-搭建ES环境"><span class="nav-text">3.3 搭建ES环境</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#3-3-1-ES启动"><span class="nav-text">3.3.1 ES启动</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3-3-2-创建索引库"><span class="nav-text">3.3.2 创建索引库</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3-3-3-创建映射"><span class="nav-text">3.3.3 创建映射</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-4-Logstash创建索引"><span class="nav-text">3.4 Logstash创建索引</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#3-4-1-创建模板文件"><span class="nav-text">3.4.1  创建模板文件</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3-4-2-配置mysql-conf"><span class="nav-text">3.4.2 配置mysql.conf</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3-4-3-测试"><span class="nav-text">3.4.3 测试</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-课程搜索"><span class="nav-text">4 课程搜索</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#4-1-需求分析"><span class="nav-text">4.1 需求分析</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-2-创建搜索服务工程"><span class="nav-text">4.2 创建搜索服务工程</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-3-API"><span class="nav-text">4.3 API</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-4-Service"><span class="nav-text">4.4 Service</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#4-4-1-按关键字搜索"><span class="nav-text">4.4.1 按关键字搜索</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#4-4-2-按分类和难度等级搜索"><span class="nav-text">4.4.2 按分类和难度等级搜索</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#4-4-3-分页与高亮"><span class="nav-text">4.4.3 分页与高亮</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-5-Controller"><span class="nav-text">4.5 Controller</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-6-测试"><span class="nav-text">4.6 测试</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="liuwy1998"
      src="/../assets/img/head.jpg">
  <p class="site-author-name" itemprop="name">liuwy1998</p>
  <div class="site-description" itemprop="description">Java开发, 后端开发</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">87</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">10</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">35</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <span class="exturl" data-url="aHR0cHM6Ly93ZWliby5jb20vNjA2MjE3MjIyNC8=" title="Weibo → https://weibo.com/6062172224/"><i class="fab fa-weibo fa-fw"></i></span>
      </span>
      <span class="links-of-author-item">
        <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3RvbnltdWE=" title="GitHub → https://github.com/tonymua"><i class="fab fa-github fa-fw"></i></span>
      </span>
      <span class="links-of-author-item">
        <span class="exturl" data-url="bWFpbHRvOmx3eTA4YUBmb3htYWlsLmNvbQ==" title="E-Mail → mailto:lwy08a@foxmail.com"><i class="fa fa-envelope fa-fw"></i></span>
      </span>
  </div>



      </div>
        <div class="back-to-top motion-element">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        
  <div class="beian"><span class="exturl" data-url="aHR0cDovL3d3dy5iZWlhbi5taWl0Lmdvdi5jbg==">皖ICP备19022525号 </span>
  </div>

<div class="copyright">
  
  &copy; 2019 – 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="heartbeat"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">liuwy1998</span>
</div><script color="0,137,108" opacity="0.5" zIndex="-1" count="99" src="https://cdn.jsdelivr.net/npm/canvas-nest.js@1/dist/canvas-nest.js"></script>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/lozad@1/dist/lozad.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/pangu@4/dist/browser/pangu.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script>
<script src="/js/schemes/pisces.js"></script>
<script src="/js/next-boot.js"></script><script src="/js/bookmark.js"></script>



  
  <script>
    (function(){
      var bp = document.createElement('script');
      var curProtocol = window.location.protocol.split(':')[0];
      bp.src = (curProtocol === 'https') ? 'https://zz.bdstatic.com/linksubmit/push.js' : 'http://push.zhanzhang.baidu.com/push.js';
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(bp, s);
    })();
  </script>




  <script src="/js/local-search.js"></script>












  

  
  <script src="//cdn.jsdelivr.net/npm/quicklink@1/dist/quicklink.umd.js"></script>
  <script>
      window.addEventListener('load', () => {
      quicklink({
        timeout : 3000,
        priority: true,
        ignores : [uri => uri.includes('#'),uri => uri === 'http://tonymua.top/64679/',]
      });
      });
  </script>

</body>
</html>
